name: Terraform Secure Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  TF_VERSION: '1.13.0'
  AWS_REGION: 'ap-northeast-2'

jobs:
  terraform-checks:
    name: 'Terraform Security & Validation'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: TFLint - Terraform Linter
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        run: |
          tflint --init
          find . -type f -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
            echo "Linting $dir"
            tflint --chdir="$dir"
          done

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          skip_check: CKV_AWS_79  # Skip specific checks if needed

  terraform-plan-dev:
    name: 'Plan - Development'
    needs: terraform-checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Plan Network Stack
        working-directory: ./environments/development/network
        run: |
          terraform init

          # Use public tfvars file + secrets
          terraform plan \
            -var-file="terraform.tfvars.public" \
            -var="sensitive_var=${{ secrets.SENSITIVE_VAR }}" \
            -out=network.tfplan

          # Convert plan to JSON for PR comment
          terraform show -json network.tfplan > network-plan.json

      - name: Plan Compute Stack
        working-directory: ./environments/development/compute
        run: |
          terraform init

          terraform plan \
            -var-file="terraform.tfvars.public" \
            -var="security_group_id=${{ secrets.SECURITY_GROUP_ID }}" \
            -var="iam_instance_profile=${{ secrets.IAM_INSTANCE_PROFILE }}" \
            -out=compute.tfplan

          terraform show -json compute.tfplan > compute-plan.json

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            // Read plan outputs
            const networkPlan = JSON.parse(fs.readFileSync('environments/development/network/network-plan.json', 'utf8'));
            const computePlan = JSON.parse(fs.readFileSync('environments/development/compute/compute-plan.json', 'utf8'));

            // Count changes
            const countChanges = (plan) => {
              const changes = plan.resource_changes || [];
              return {
                add: changes.filter(c => c.change?.actions?.includes('create')).length,
                change: changes.filter(c => c.change?.actions?.includes('update')).length,
                destroy: changes.filter(c => c.change?.actions?.includes('delete')).length
              };
            };

            const networkChanges = countChanges(networkPlan);
            const computeChanges = countChanges(computePlan);

            // Create comment
            const comment = `## üìã Terraform Plan Results

            ### Network Stack
            - ‚ûï **Add:** ${networkChanges.add}
            - üîÑ **Change:** ${networkChanges.change}
            - ‚ûñ **Destroy:** ${networkChanges.destroy}

            ### Compute Stack
            - ‚ûï **Add:** ${computeChanges.add}
            - üîÑ **Change:** ${computeChanges.change}
            - ‚ûñ **Destroy:** ${computeChanges.destroy}

            ‚ö†Ô∏è **Review the changes carefully before merging!**`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  terraform-apply:
    name: 'Apply - Production'
    needs: terraform-checks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://console.aws.amazon.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Deploy Network Stack
        working-directory: ./environments/development/network
        run: |
          terraform init

          terraform apply \
            -var-file="terraform.tfvars.public" \
            -auto-approve

      - name: Deploy Compute Stack
        working-directory: ./environments/development/compute
        run: |
          terraform init

          terraform apply \
            -var-file="terraform.tfvars.public" \
            -var="security_group_id=${{ secrets.SECURITY_GROUP_ID }}" \
            -var="iam_instance_profile=${{ secrets.IAM_INSTANCE_PROFILE }}" \
            -auto-approve

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Terraform Deployment ${{ job.status }}
            Environment: Development
            Triggered by: ${{ github.actor }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  terraform-destroy:
    name: 'Destroy Infrastructure'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: destroy-approval

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Destroy Compute Stack First
        working-directory: ./environments/development/compute
        run: |
          terraform init
          terraform destroy \
            -var-file="terraform.tfvars.public" \
            -var="security_group_id=${{ secrets.SECURITY_GROUP_ID }}" \
            -var="iam_instance_profile=${{ secrets.IAM_INSTANCE_PROFILE }}" \
            -auto-approve

      - name: Destroy Network Stack
        working-directory: ./environments/development/network
        run: |
          terraform init
          terraform destroy \
            -var-file="terraform.tfvars.public" \
            -auto-approve