name: Terraform Plan on PR

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/terraform-*.yml'

env:
  TF_VERSION: '1.13.0'
  AWS_REGION: 'ap-northeast-2'
  TF_LOG: INFO

jobs:
  detect-changes:
    name: Detect Environment Changes
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed environments
        id: detect
        run: |
          # PRÏùò Î≥ÄÍ≤ΩÎêú ÌååÏùºÎì§ ÌôïÏù∏
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Î≥ÄÍ≤ΩÎêú ÌôòÍ≤Ω Í∞êÏßÄ
          ENVIRONMENTS=""
          if echo "$CHANGED_FILES" | grep -q "modules/"; then
            # Î™®ÎìàÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ Î™®Îì† ÌôòÍ≤Ω ÌôïÏù∏
            ENVIRONMENTS="development staging production"
          else
            # ÌäπÏ†ï ÌôòÍ≤ΩÎßå Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞
            for env in development staging production; do
              if echo "$CHANGED_FILES" | grep -q "environments/$env/"; then
                ENVIRONMENTS="$ENVIRONMENTS $env"
              fi
            done
          fi

          # Í≤∞Í≥º Ï∂úÎ†•
          if [ -z "$ENVIRONMENTS" ]; then
            echo "environments=[]" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            ENV_JSON="["
            MATRIX_JSON="{\"include\":["
            for env in $ENVIRONMENTS; do
              ENV_JSON="$ENV_JSON\"$env\","
              MATRIX_JSON="$MATRIX_JSON{\"environment\":\"$env\"},"
            done
            ENV_JSON="${ENV_JSON%,}]"
            MATRIX_JSON="${MATRIX_JSON%,}]}"

            echo "environments=$ENV_JSON" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

            echo "Changed environments: $ENVIRONMENTS"
          fi

  terraform-plan:
    name: Plan - ${{ matrix.environment }}
    needs: detect-changes
    if: needs.detect-changes.outputs.environments != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Find Terraform directories
        id: find-dirs
        run: |
          # ÌôòÍ≤ΩÎ≥Ñ Terraform ÎîîÎ†âÌÜ†Î¶¨ Ï∞æÍ∏∞
          DIRS=$(find environments/${{ matrix.environment }} -name "*.tf" -type f -exec dirname {} \; | sort -u)
          echo "dirs<<EOF" >> $GITHUB_OUTPUT
          echo "$DIRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Found directories for ${{ matrix.environment }}:"
          echo "$DIRS"

      - name: Terraform Plan
        id: plan
        run: |
          PLAN_OUTPUT=""
          PLAN_EXITCODE=0

          # Í∞Å ÎîîÎ†âÌÜ†Î¶¨Ïóê ÎåÄÌï¥ plan Ïã§Ìñâ
          while IFS= read -r dir; do
            [ -z "$dir" ] && continue

            echo "::group::Planning $dir"
            cd "${{ github.workspace }}/$dir"

            # Initialize
            terraform init -backend-config="key=${{ matrix.environment }}/$(basename $dir)/terraform.tfstate"

            # Format check
            terraform fmt -check=true -diff

            # Validate
            terraform validate

            # Plan
            set +e
            PLAN_RESULT=$(terraform plan -var-file="${{ matrix.environment }}.tfvars" -no-color -out=tfplan 2>&1)
            EXITCODE=$?
            set -e

            if [ $EXITCODE -ne 0 ]; then
              PLAN_EXITCODE=$EXITCODE
            fi

            PLAN_OUTPUT="$PLAN_OUTPUT

          ### üìÅ Directory: \`$dir\`

          <details>
          <summary>Terraform Plan Output</summary>

          \`\`\`hcl
          $PLAN_RESULT
          \`\`\`

          </details>"

            echo "::endgroup::"
          done <<< "${{ steps.find-dirs.outputs.dirs }}"

          # GitHub Ï∂úÎ†• ÏÑ§Ï†ï
          echo "plan_output<<EOF" >> $GITHUB_OUTPUT
          echo "$PLAN_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "exitcode=$PLAN_EXITCODE" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const environment = '${{ matrix.environment }}';
            const planOutput = `${{ steps.plan.outputs.plan_output }}`;
            const exitCode = '${{ steps.plan.outputs.exitcode }}';

            const status = exitCode === '0' ? '‚úÖ' : '‚ùå';
            const statusText = exitCode === '0' ? 'succeeded' : 'failed';

            const output = `## ${status} Terraform Plan - \`${environment}\`

            Plan ${statusText} for environment: **${environment}**

            ${planOutput}

            ---
            *Workflow: \`${{ github.workflow }}\` | Run: \`${{ github.run_id }}\`*`;

            // Í∏∞Ï°¥ ÏΩîÎ©òÌä∏ Ï∞æÍ∏∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes(`Terraform Plan - \`${environment}\``)
            );

            // ÏΩîÎ©òÌä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÎòêÎäî ÏÉùÏÑ±
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      - name: Plan Status
        if: steps.plan.outputs.exitcode != '0'
        run: exit ${{ steps.plan.outputs.exitcode }}

  plan-summary:
    name: Plan Summary
    needs: [detect-changes, terraform-plan]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Summary Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const environments = ${{ needs.detect-changes.outputs.environments || '[]' }};

            let summary = '## üìã Terraform Plan Summary\n\n';

            if (environments.length === 0) {
              summary += '> ‚ÑπÔ∏è No Terraform changes detected in this PR\n';
            } else {
              summary += '| Environment | Status |\n';
              summary += '|-------------|--------|\n';

              for (const env of environments) {
                // Í∞Å ÌôòÍ≤ΩÏùò job ÏÉÅÌÉú ÌôïÏù∏
                const status = 'üîÑ Check individual plan results above';
                summary += `| ${env} | ${status} |\n`;
              }

              summary += '\n> üí° Review the plan outputs above before merging\n';
            }

            // Í∏∞Ï°¥ summary ÏΩîÎ©òÌä∏ Ï∞æÍ∏∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const summaryComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraform Plan Summary')
            );

            if (summaryComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: summaryComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }